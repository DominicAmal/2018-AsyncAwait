<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Async functions in practice</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/sky.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/tomorrow.css">

    <link rel="stylesheet" href="plugin/line-numbers/line-numbers.css">

    <!-- My own customizations -->
    <style>
      .reveal pre code {
        padding: 1em;
      }
      .reveal mark {
        background-color: #ffaaaa;
      }
      .reveal li {
        margin: 0.5em 0;
      }

      .reveal .attribution {
        position: fixed;
        bottom: 0px;
        width: 90%;
        font-size: 0.4em;
        font-style: italic;
      }

      .reveal .ok:before {
        color: green;
        content: "\2713\00a0";
      }

      .reveal .notok:before {
        color: red;
        content: "\2717\00a0";
      }

      .reveal .note {
        font-size: 0.8em;
        font-style: italic;
      }

      ul.nodisc {
        list-style-type: none;
      }

      code span.highlight-line:before {
        color: #4d4d4c !important;
        font-weight: bold;
      }
    </style>

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
<!-- ======= SLIDES START ======= -->

<section>
  <br/>
  <h2>Async functions<br/>in practice</h2>
  <h4><em>
    tips, tricks and caveats you want to know<br/>
    before migrating from callbacks
  </em></h4>
  <br/>
  <br/>
  <div style="text-align: right">Miroslav Bajtoš</div>
</section>

<section>
  <h2>Agenda</h2>
  <ul>
    <li class="fragment"><code>async</code> and <code>await</code> are awesome!
    <li class="fragment">implementation status
    <li class="fragment">ecosystem readiness
    <li class="fragment">tips &amp; tricks
    <li class="fragment">caveats
  </ul>
</section>

<section>
  <h2>My personal story</h2>
  <p>async, await &amp; LoopBack Next
  <!--
    In January 2017, we started LB Next as a complete rewrite
    using TypeScript and latest language goodness including async/await.

    At that time, async/await was available in Node.js behind a feature
    flag and the performance was terrible. And by terrible I mean async/await
    was about ~6x slower than callbacks. For comparison, in Node.js 10.5.0,
    async/await is only ~2x slower than callbacks.

    Fast forward 1.5 years and I am happy that my scepticism was overruled
    by other team members. We are still maintaining our legacy code base
    from ES5 days and it's so less fun that ES2017!
  -->
</section>

<section>
  <section>
    <h2><code>async &amp; await</code></h2>
    and its goodness
  </section>

  <section>
    <h3>Cleaner code</h3>
  </section>

  <section><pre><code class="javascript" data-trim data-noescape>
  it('creates a product in a category', (done) =&gt; {
    Category.create({name: 'Food'}, (err, cat) =&gt; {
      <mark class="fragment">if (err) return done(err);</mark>

      cat.products.create({name: 'Apple'}, (err, prod) =&gt; {
        <mark class="fragment"> if (err) return done(err);</mark>

        expect(prod).to.have.property('categoryId', cat.id);
        done();
      });
    });
  });
  </code></pre></section>

  <section><pre><code class="javascript" data-trim data-noescape>
  it('creates a product in a category', <mark>async ()</mark> =&gt; {
    const cat = <mark>await</mark> Category.create({name: 'Food'});
    const prod = <mark>await</mark> cat.products.create({name: 'Apple'});
    expect(prod).to.have.property('categoryId', cat.id);
  });
  </code></pre></section>

  <section>
    <h3>Better error stack traces</h3>
  </section>

  <section>
    <p>Callbacks
    <pre><code class="javascript line-numbers" data-trim data-noescape data-highlight-lines="5">
    function step(cb) { process.nextTick(cb); }

    function walk(cb) {
      return step(err =&gt; {
        <mark>cb(new Error('too tired'));</mark>
      });
    }

    /*
    Error: too tired
        at step (walk-callback.js:5:8)
        at process._tickCallback (next_tick.js:61:11)
    */
    </code></pre>
  </section>

  <section>
    <p>Promises
    <pre><code class="javascript line-numbers" data-trim data-noescape data-highlight-lines="5">
    function step() { return Promise.resolve(); }

    function walk() {
      return step().then(() =&gt; {
        <mark>throw new Error('too tired');</mark>
      });
    }

    /*
    Error: too tired
        at step.then (walk-promise.js:5:11)
        at process._tickCallback (next_tick.js:68:7)
    */
    </code></pre>
  </section>

  <section>
    <p>Async &amp; await
    <pre><code class="javascript line-numbers" data-trim data-noescape data-highlight-lines="5">
    async function step() {}

    async function walk() {
      await step();
      <mark>throw new Error('too tired');</mark>
    }

    /*
    Error: too tired
        at walk (walk-async.js:5:9)
        at process._tickCallback (next_tick.js:68:7)
    */
    </code></pre>
  </section>

  <section>
    <h3>The debugger</h3>
    <p>F10 steps over await statements
  </section>
</section>

<section>
  <section>
    <h2>Implementation status</h2>
  </section>

  <section>
    <h3>The language</h3>
    <p>ES2017
    <p class="note">(January 2017)
  </section>

  <section>
    <h3>The runtime</h3>
    <p>Node.js 8.9.0 LTS
    <p class="note">(October 2017)
  </section>

  <section>
    <h3>Node.js core API</h3>
    <img
         src="./img/under-construction.png"
         alt="work in progres"
         style="border:none; background: none; box-shadow: none;"
         height="150"
    />
    <p><em>(see <a
       href="https://github.com/nodejs/node/issues/15413">nodejs/node#15413)</a></em>
  </section>

  <section>
    <h3>Node.js&nbsp;&nbsp;8&nbsp;&nbsp;(LTS)</h3>
    <p><code>util.promisify()</code></p>
    <p>(more on this later)</p>
  </section>
  <section>
    <h3>Node.js&nbsp;&nbsp;10</h3>
    <p><code>require('fs').promises</code></p>
    <br/>
    <h4>Experimental:</h4>
    <p><code>require('dns').promises</code></p>
  </section>
</section>

<section>
  <section>
    <h2>Ecosystem readiness</h2>
  </section>

  <section>
    <h3>HTTP clients</h3>
    <ul class="nodisc">
      <li class="notok"><a href="https://www.npmjs.com/package/request">request</a>
        <span class="note">(but see <a href="https://www.npmjs.com/package/request-promise-native">request-promise-native</a>)</span>
      <li class="ok"><a href="https://www.npmjs.com/package/superagent">superagent</a>
      <li class="ok"><a href="https://www.npmjs.com/package/node-fetch">node-fetch</a>
      <li class="ok"><a href="https://www.npmjs.com/package/swagger-client">swagger-client</a>
    </ul>
  </section>

  <section>
    <h3>Server frameworks</h3>
    <ul class="nodisc">
      <li class="notok"><a href="https://www.npmjs.com/package/express">Express</a>
        <span class="note">(but see <a href="https://www.npmjs.com/package/express-promise-router">express-promise-router</a></span>)
      <li class="ok"><a href="https://www.npmjs.com/package/loopback">LoopBack</a>
        <span class="note">(REST API layer)</span>
      <li class="ok"><a href="https://www.npmjs.com/package/hapi">Hapi</a>
      <li class="ok"><a href="https://www.npmjs.com/package/koa">Koa</a>
      <li class="ok"><a href="https://www.npmjs.com/package/fastify">Fastify</a>
        <span class="note">(routes are async, middleware is callback-based.)</span>
      <li class="notok"><a href="https://www.npmjs.com/package/restify">Restify</a>
        <span class="note">(but see <a href="https://www.npmjs.com/package/restify-await-promise">restify-await-promise</a></span>)
    </ul>
  </section>

  <section>
    <h3>ORMs</h3>
    <ul class="nodisc">
      <li class="ok"><a href="https://www.npmjs.com/package/loopback">LoopBack</a>
        <span class ="note">(ORM layer)</span>
      <li class="ok"><a href="https://www.npmjs.com/package/knex">Knex</a>
      <li class="ok"><a href="https://www.npmjs.com/package/bookshelf">Bookshelf</a>
      <li class="ok"><a href="https://www.npmjs.com/package/sequelize">Sequelize</a>
      <li class="ok"><a href="https://www.npmjs.com/package/objection">Objection</a>
      <li class="ok"><a href="https://www.npmjs.com/package/mongoose">Mongoose</a>
    </ul>
  </section>

  <section>
    <h3>Database clients</h3>
    <ul class="nodisc">
      <li class="ok"><a href="https://www.npmjs.com/package/mongodb">MongoDB</a>
      <li class="ok"><a href="https://www.npmjs.com/package/pg">pg (PostgreSQL)</a>
      <li class="notok"><a href="https://www.npmjs.com/package/mysql">MySQL</a>
        <span class ="note">(see 3rd party wrappers adding Promise support)</span>
      <li class="notok"><a href="https://www.npmjs.com/package/redis">Redis</a>
      <li class="ok"><a href="https://www.npmjs.com/package/ioredis">ioredis</a>
    </ul>
  </section>
</section>

<section>
  <section>
    <h2>Tips &amp; tricks</h2>
  </section>

  <section>
    <h3>Interop with Promises</h3>
  </section>

  <section>
    <p><code>await</code> any Promise
    <pre><code class="javascript" data-trim>
    function sleep(ms) {
      return new Promise((resolve, reject) => {
        setTimeout(resolve, ms);
      });
    }

    await sleep(100);
    </code></pre>
  </section>
  <section>
    <p><code>async</code> functions return a promise
    <pre><code class="javascript" data-trim>
    async function step() {
      console.log('raise your foot');
      await sleep(100);
      console.log('lower your foot');
    }

    step().then(() => console.log('done'));
    </code></pre>
  </section>

  <section>
    <h3>Run tasks in parallel</h3>
    <!--
      `await` runs tasks in series
      use `Promise.all` for parallel execution
    -->
    <pre><code class="javascript" data-trim>
    await Promise.all([
      walk(),
      talk(),
    ]);
    </code></pre>
  </section>

  <section>
    <h3>Await callback-based functions</h3>
    <pre><code class="javascript" data-trim data-noescape>
    const util = require('util');
    const fs = require('fs');
    <mark>const readFile = util.promisify(fs.readFile);</mark>

    async function readData() {
      return await readFile('data.txt', 'utf-8');
    }
    </code></pre>
  </section>

  <section>
    <h3>Promisify classes</h3>
    <p>you are on your own :(
    <p><a href="https://www.npmjs.com/package/pifall">
      <code>pifall</code></a>
    <p><a href="https://www.npmjs.com/package/pify">
      <code>pify</code></a>
    <p><a href="http://bluebirdjs.com/docs/api/promise.promisifyall.html">
      <code>Bluebird.promisifyAll()</code></a>
  </section>


  <section>
    <h3>Multiple callback arguments</h3>
  </section>

  <section>
    <h4>Node.js core API</h4>
    <pre><code class="javascript" data-trim data-noescape>
    fs.read(fd, buffer, offset, len, pos,
      <mark>(err, bytesRead, buffer)</mark> =&gt; {
        // ...
      });

    const readAsync = util.promisify(fs.read);
    <mark>const {bytesRead, buffer} = await readAsync</mark>(fd, /*...*/pos);
    </code></pre>
  </section>

  <section>
    <h4>User-land API</h4>
    <p>you are own your own :(</p>
    <pre class="fragment"><code class="javascript" data-trim data-noescape>
    function whoami(callback) {
     callback(null, 'Miroslav', 'Bajtos');
    }

    function whoamiAsync() {
      return new Promise((resolve, reject) =&gt; {
        whoami(<mark>(err, name, surname)</mark> =&gt; {
          if (err) reject(err);
          else <mark>resolve({name, surname});</mark>
        });
      });
    };

    const {name, surname} = await whoamiAsync();
    </code></pre>
  </section>

  <section>
    <p>if you own the API
    <pre><code class="javascript" data-trim data-noescape>
    whoami[util.promisify.custom] = whoamiAsync;
    </code></pre>
    <p class="note">(see <a href="https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_custom_promisified_functions">
      Custom promisified functions</a> in Node.js docs)
  </section>

  <section>
    <h3>Await events</h3>
    <pre><code class="javascript" data-trim data-noescape>
    const http = require('http');
    <mark>const pEvent = require('p-event');</mark>

    async function start(handler) {
      const server = http.createServer(handler);
      server.listen(0);

      <mark>await pEvent(server, 'listen');</mark>
      return `http://localhost:${server.address().port}/`;
    }

    start(/*handler*/).then(
      url =&gt; console.log('Listening on:', url),
      <mark>err =&gt; console.log('Cannot start the server:', err)</mark>
    );
    </code></pre>
  </section>

  <section>
    <h3>Async functions in<br/>callback-based code</h3>
  </section>
  <section>
    <p>Can you spot two problems?
    <pre><code class="javascript" data-trim>
    async function step() {
      return 'some data';
    }

    app.use((req, res, next) => {
      step()
        .then(next)
        .catch(next);
    });
    </code></pre>
  </section>
  <section>
    <p>The right way&trade;
    <pre><code class="javascript" data-trim>
    async function step() {
      return 'some data';
    }

    app.use((req, res, next) => {
      step().then(
        // onFulfilled
        success => process.nextTick(next),
        // onRejected
        error => process.nextTick(next, error)
      );
    });
    </code></pre>
  </section>

  <section>
    <h3><code>return await or not?</code></h3>
    <pre><code class="javascript" data-trim>
    async function getRepos() {
      const url = 'https://api.github.com/users/bajtos/repos';

      // GOOD: return the promise immediately
      return request(url);

      // NOT RECOMMENDED: await the result before returning
      return await request(url);
    }
    </code></pre>
    <p>avoid <a
      href="http://exploringjs.com/es2016-es2017/ch_async-functions.html#_returned-promises-are-not-wrapped">promise
      rewrapping</a>
  </section>
</section>

<section>
  <section>
    <h2>Caveats</h2>
  </section>
  <section>
    <p><code>async</code> functions return a native promise
    <pre><code class="javascript" data-trim>
    const Bluebird = require('bluebird');
    async function test() {
      return Bluebird.resolve(1);
    }

    console.log(test() instanceof Bluebird)
    // false

    console.log('spread' in test());
    // false
    </code></pre>
  </section>
  <section>
    <h3>Unhandled errors</h3>
    <pre><code class="javascript" data-trim>
    async function tick() {
      throw new Error('BOOM!');
    }

    // missing await or then
    tick();
    </code></pre>
    <p>logs a warning, does not crash (yet)
    <p><a href="https://nodejs.org/dist/latest-v8.x/docs/api/process.html#process_event_unhandledrejection">
      <code>process.on('unhandledRejection')</code></a>
  </section>
  <section>
    <h3>User-land Promise libraries</h3>
  </section>
  <section>
    <p>How to detect unhandled rejections?
  </section>
  <section>
    <h3>Invalid API usage<br/>vs.<br/>operational errors</h3>
    <p>(see <a href="https://www.joyent.com/node-js/production/design/errors">Error Handling in Node.js</a>)
  </section>
  <section>
    <h4>Invalid API usage with a callback</h4>
    <pre><code class="javascript" data-trim>
    fs.readFile(undefined, console.log)
    </code></pre>
    <p>(process crashed)
    <pre><code class="json" data-trim>
    fs.js:358
      binding.open(pathModule._makeLong(path),
              ^

    TypeError: path must be a string or Buffer
        at Object.fs.readFile (fs.js:358:11)
        (...)
    </code></pre>
  </section>
  <section>
    <h4>Operational error with a callback</h4>
    <pre><code class="javascript" data-trim>
    fs.readFile('unknown.txt', console.log)
    </code></pre>
    <p>(the process happily keeps running)
    <pre><code class="json" data-trim>
    { Error: ENOENT: no such file or directory, open 'unknown.txt'
      errno: -2,
      code: 'ENOENT',
      syscall: 'open',
      path: 'does-not-exist' }
    </code></pre>
  </section>
  <section>
    <h4>Any error in an async function</h4>
    <p>always reported as a promise rejection
    <p><em>(discussion: <a href="https://github.com/nodejs/promises/issues/10">nodejs/promises#10</a>)</em>
  </section>
  <section>
    <h3>Post-mortem debugging</h3>
    <p><code>node --abort-on-uncaught-exception</code>
    <p><em>(learn more: <a href="https://www.joyent.com/blog/post-mortem-debugging-and-promises">Post-mortem Debugging and Promises</a>)</em>
  </section>
</section>
<section>
  <section>
    <h2>Performance</h2>
  </section>
  <section>
    <h3>Microbenchmark</h3>
    <canvas data-chart="horizontalBar">
      <!--
        {
          "data": {
            "labels": [
              "callbacks",
              "Bluebird",
              "await Bluebird",
              "util.promisify",
              "await util.promisify"
            ],
            "datasets": [{
              "label": "time to complete (ms)",
              "data": [161, 273, 259, 341, 330],
              "backgroundColor": [
                "rgba(54, 162, 235, 0.6)",
                "rgba(54, 162, 235, 0.6)",
                "rgba(54, 162, 235, 0.6)",
                "rgba(54, 162, 235, 0.6)",
                "rgba(54, 162, 235, 0.6)"
              ]
            }]
          },
          "options": {
            "scales": {
              "xAxes":[{"ticks":{"beginAtZero":true}}]
            }
          }
        }
      -->
    </canvas>
    <p class="note"><a href="https://github.com/strongloop-forks/bluebird/tree/async/await">https://github.com/strongloop-forks/bluebird/tree/async/await</a>
  </section>
  <section>
    <h3>A "real" app</h3>
    <canvas data-chart="horizontalBar">
      <!--
        {
          "data": {
            "labels": ["Hapi", "Fastify", "Koa+router", "Express"],
            "datasets": [{
              "label": "requests per second",
              "data": [5875, 7905, 7269, 5610],
              "backgroundColor": [
                "rgba(54, 162, 235, 0.6)",
                "rgba(54, 162, 235, 0.6)",
                "rgba(54, 162, 235, 0.6)",
                "rgba(54, 162, 235, 0.6)"
              ]
            }]
          },
          "options": {
            "scales": {
              "xAxes":[{"ticks":{"beginAtZero":true}}]
            }
          }
        }
      -->
    </canvas>
    <p class="note"><a href="https://github.com/bajtos/async-frameworks">https://github.com/bajtos/async-frameworks</a>
  </section>

  <section>
    <h3>Faster core APIs?</h3>
    <p><a href="https://github.com/nodejs/node/pull/15485">nodejs/node#15485</a>
    <pre><code class="json" data-trim data-noescape>
    fs/promises-access.js method="legacy"    163,294.66290369138
    fs/promises-access.js method="promisify" 119,130.69228308211
    fs/promises-access.js method="promise"   185,855.53426089959
    </code></pre>
  </section>
</section>

<section>
  <section>
    <h2>Streams</h2>
    <p>(the future)</p>
  </section>

  <!--
  <section>
    <ul>
      <li>reading from streams
      <li>writing to streams
      <li>creating Readable streams
      <li>creating Writable streams
      <li>creating Transform streams
    </ul>
  </section>
  -->

  <section>
    <h3>Async Iterators</h3>
  </section>
  <section>
    <h4>Status</h4>
    <p><code>node --harmony-async-iteration</code>
    <p>TC39: stage 3 proposal
    <p class="note"><a href="https://github.com/tc39/proposal-async-iteration">https://github.com/tc39/proposal-async-iteration</a>
  </section>
  <section>
    <pre><code class="javascript" data-trim>
    for await (const line of readLines(filePath)) {
      console.log(line);
    }
    </code></pre>
  </section>
  <section>
    <h3>Streams as Async Iterators</h3>
    <p class="note">(inspired by <a href="https://streams.spec.whatwg.org/">WhatWG Streams</a>)
  </section>
  <section>
    <h4>Read from streams</h4>
    <pre><code class="javascript" data-trim data-noescape>
    const inputStream = byline(fs.createReadStream(
      pathToFile, {encoding: 'utf-8'})));

    const reader = <mark>asyncIterStream.wrap(inputStream);</mark>
    for await (const line of reader) {
      console.log(line);
    }
    </code></pre>
    <p class="note"><a href="https://github.com/calvinmetcalf/async-iter-stream">https://github.com/calvinmetcalf/async-iter-stream</a>
  </section>
  <!--
  <section>
    <h4>Write to streams</h4>
    <p><em>(just dreaming)</em>
    <pre><code class="javascript" data-trim data-noescape>
    for await (const chunk of src) {
      await dest.write(chunk);
    }
    await dest.end();
    </code></pre>
    <p>backpressure!
  </section>
  <section>
    <h4>Create Readable streams</h4>
    <p><em>(just dreaming)</em>
    <pre><code class="javascript" data-trim data-noescape>
      new ReadableStream({
        async * _read() {
          for (const url of sourceUrls) {
            yield await fetch(url);
          }
        }
      });
    </code></pre>
  </section>
  <section>
    <h4>Create Writable streams</h4>
    <p><em>(just dreaming)</em>
    <pre><code class="javascript" data-trim data-noescape>
    new WritableStream({
      <mark>async write(chunk, encoding)</mark> {
        //...
      },
      <mark>async destroy()</mark> {
        // ...
      },
    });
    </code></pre>
    <p>backpressure!
  </section>
  <section>
    <h4>Create Transform streams</h4>
    <pre><code class="javascript" data-trim data-noescape>
    new TransformStream({
      buffer: '';
      <mark>async *transform(chunk, encoding)</mark> {
        buffer += chunk;
        const lines = /*await*/ buffer.split('\n');
        buffer = lines.pop();
        for (const l of lines) {
          yield l;
        }
      },
      <mark>async *flush()</mark> {
        yield buffer;
      },
    });
    </code></pre>
    <p>backpressure!
  </section>
  -->
  <section>
    <h4>And the rest?</h4>
    <p>The exact shape of the new Streams API in Node.js is not determined yet.
  </section>
</section>

<section>
  <section>
    <h2>Key takeaways</h2>
  </section>
  <section>
    <p><code>async</code> functions are awesome
    <p>and ready to use
  </section>
  <section>
    <p>understand the caveats
    <p class="note">(brought by the new programming model)
  </section>
  <section>
    <p>know your dependencies
    <p class="note">(and the Promise libraries they use)
  </section>
</section>

<section>
<br/>
<br/>
<h2>Thank you!</h2>
<br/>
<br/>
<p><em>Miroslav Bajtoš</em>
<p><a href="https://bajtos.net/">https://bajtos.net/</a>
</section>



<!-- ======= SLIDES END ======= -->
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
        progress: true,
        history: true,
        dependencies: [
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/notes/notes.js', async: true },
          {
            src: 'plugin/highlight/highlight.js',
            async: true,
            callback: function() { hljs.initHighlightingOnLoad(); }
          },
          { src: 'plugin/chart/Chart.min.js' },
          { src: 'plugin/chart/csv2chart.js' },
          { src: 'plugin/line-numbers/line-numbers.js'},
        ],
      });
    </script>
  </body>
</html>
